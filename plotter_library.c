<<<<<<< HEAD:plotter_library.c
/**
 * @file example.c
 * @brief This file contains the implementation of ...
 * @author Justin Troth
 */

#include "xc.h"
#include "plotter_utils.h"
#include "lcd_library.h"
#include "plotter_library.h"

#define ARCTAN_TABLE_SIZE 1024

const unsigned int inner_angle_table[1447] = {65535, 65514, 65494, 65473, 65453, 65433, 65412, 65392, 65372, 65351, 65331, 65310, 65290, 65270, 65249, 65229, 65209, 65188, 65168, 65147, 65127, 65107, 65086, 65066, 65046, 65025, 65005, 64984, 64964, 64944, 64923, 64903, 64883, 64862, 64842, 64821, 64801, 64781, 64760, 64740, 64720, 64699, 64679, 64658, 64638, 64618, 64597, 64577, 64557, 64536, 64516, 64495, 64475, 64455, 64434, 64414, 64394, 64373, 64353, 64332, 64312, 64292, 64271, 64251, 64231, 64210, 64190, 64169, 64149, 64129, 64108, 64088, 64067, 64047, 64027, 64006, 63986, 63966, 63945, 63925, 63904, 63884, 63864, 63843, 63823, 63802, 63782, 63762, 63741, 63721, 63700, 63680, 63660, 63639, 63619, 63599, 63578, 63558, 63537, 63517, 63497, 63476, 63456, 63435, 63415, 63395, 63374, 63354, 63333, 63313, 63293, 63272, 63252, 63231, 63211, 63191, 63170, 63150, 63129, 63109, 63089, 63068, 63048, 63027, 63007, 62986, 62966, 62946, 62925, 62905, 62884, 62864, 62844, 62823, 62803, 62782, 62762, 62742, 62721, 62701, 62680, 62660, 62639, 62619, 62599, 62578, 62558, 62537, 62517, 62496, 62476, 62456, 62435, 62415, 62394, 62374, 62353, 62333, 62313, 62292, 62272, 62251, 62231, 62210, 62190, 62170, 62149, 62129, 62108, 62088, 62067, 62047, 62026, 62006, 61986, 61965, 61945, 61924, 61904, 61883, 61863, 61842, 61822, 61802, 61781, 61761, 61740, 61720, 61699, 61679, 61658, 61638, 61617, 61597, 61576, 61556, 61536, 61515, 61495, 61474, 61454, 61433, 61413, 61392, 61372, 61351, 61331, 61310, 61290, 61269, 61249, 61228, 61208, 61188, 61167, 61147, 61126, 61106, 61085, 61065, 61044, 61024, 61003, 60983, 60962, 60942, 60921, 60901, 60880, 60860, 60839, 60819, 60798, 60778, 60757, 60737, 60716, 60696, 60675, 60655, 60634, 60614, 60593, 60573, 60552, 60531, 60511, 60490, 60470, 60449, 60429, 60408, 60388, 60367, 60347, 60326, 60306, 60285, 60265, 60244, 60224, 60203, 60182, 60162, 60141, 60121, 60100, 60080, 60059, 60039, 60018, 59998, 59977, 59956, 59936, 59915, 59895, 59874, 59854, 59833, 59813, 59792, 59771, 59751, 59730, 59710, 59689, 59669, 59648, 59627, 59607, 59586, 59566, 59545, 59525, 59504, 59483, 59463, 59442, 59422, 59401, 59380, 59360, 59339, 59319, 59298, 59277, 59257, 59236, 59216, 59195, 59174, 59154, 59133, 59113, 59092, 59071, 59051, 59030, 59009, 58989, 58968, 58948, 58927, 58906, 58886, 58865, 58844, 58824, 58803, 58782, 58762, 58741, 58721, 58700, 58679, 58659, 58638, 58617, 58597, 58576, 58555, 58535, 58514, 58493, 58473, 58452, 58431, 58411, 58390, 58369, 58349, 58328, 58307, 58287, 58266, 58245, 58225, 58204, 58183, 58162, 58142, 58121, 58100, 58080, 58059, 58038, 58018, 57997, 57976, 57955, 57935, 57914, 57893, 57873, 57852, 57831, 57810, 57790, 57769, 57748, 57727, 57707, 57686, 57665, 57645, 57624, 57603, 57582, 57562, 57541, 57520, 57499, 57479, 57458, 57437, 57416, 57395, 57375, 57354, 57333, 57312, 57292, 57271, 57250, 57229, 57209, 57188, 57167, 57146, 57125, 57105, 57084, 57063, 57042, 57021, 57001, 56980, 56959, 56938, 56917, 56897, 56876, 56855, 56834, 56813, 56792, 56772, 56751, 56730, 56709, 56688, 56667, 56647, 56626, 56605, 56584, 56563, 56542, 56521, 56501, 56480, 56459, 56438, 56417, 56396, 56375, 56355, 56334, 56313, 56292, 56271, 56250, 56229, 56208, 56187, 56167, 56146, 56125, 56104, 56083, 56062, 56041, 56020, 55999, 55978, 55957, 55937, 55916, 55895, 55874, 55853, 55832, 55811, 55790, 55769, 55748, 55727, 55706, 55685, 55664, 55643, 55622, 55601, 55581, 55560, 55539, 55518, 55497, 55476, 55455, 55434, 55413, 55392, 55371, 55350, 55329, 55308, 55287, 55266, 55245, 55224, 55203, 55182, 55161, 55140, 55119, 55098, 55077, 55056, 55035, 55013, 54992, 54971, 54950, 54929, 54908, 54887, 54866, 54845, 54824, 54803, 54782, 54761, 54740, 54719, 54698, 54677, 54655, 54634, 54613, 54592, 54571, 54550, 54529, 54508, 54487, 54466, 54444, 54423, 54402, 54381, 54360, 54339, 54318, 54297, 54275, 54254, 54233, 54212, 54191, 54170, 54149, 54127, 54106, 54085, 54064, 54043, 54022, 54000, 53979, 53958, 53937, 53916, 53895, 53873, 53852, 53831, 53810, 53789, 53767, 53746, 53725, 53704, 53682, 53661, 53640, 53619, 53598, 53576, 53555, 53534, 53513, 53491, 53470, 53449, 53428, 53406, 53385, 53364, 53343, 53321, 53300, 53279, 53257, 53236, 53215, 53194, 53172, 53151, 53130, 53108, 53087, 53066, 53044, 53023, 53002, 52980, 52959, 52938, 52916, 52895, 52874, 52852, 52831, 52810, 52788, 52767, 52746, 52724, 52703, 52681, 52660, 52639, 52617, 52596, 52575, 52553, 52532, 52510, 52489, 52467, 52446, 52425, 52403, 52382, 52360, 52339, 52318, 52296, 52275, 52253, 52232, 52210, 52189, 52167, 52146, 52124, 52103, 52081, 52060, 52038, 52017, 51996, 51974, 51953, 51931, 51910, 51888, 51866, 51845, 51823, 51802, 51780, 51759, 51737, 51716, 51694, 51673, 51651, 51630, 51608, 51586, 51565, 51543, 51522, 51500, 51479, 51457, 51435, 51414, 51392, 51371, 51349, 51327, 51306, 51284, 51263, 51241, 51219, 51198, 51176, 51154, 51133, 51111, 51089, 51068, 51046, 51024, 51003, 50981, 50959, 50938, 50916, 50894, 50873, 50851, 50829, 50808, 50786, 50764, 50742, 50721, 50699, 50677, 50655, 50634, 50612, 50590, 50568, 50547, 50525, 50503, 50481, 50460, 50438, 50416, 50394, 50372, 50351, 50329, 50307, 50285, 50263, 50242, 50220, 50198, 50176, 50154, 50132, 50111, 50089, 50067, 50045, 50023, 50001, 49979, 49958, 49936, 49914, 49892, 49870, 49848, 49826, 49804, 49782, 49760, 49739, 49717, 49695, 49673, 49651, 49629, 49607, 49585, 49563, 49541, 49519, 49497, 49475, 49453, 49431, 49409, 49387, 49365, 49343, 49321, 49299, 49277, 49255, 49233, 49211, 49189, 49167, 49145, 49123, 49101, 49079, 49057, 49035, 49013, 48990, 48968, 48946, 48924, 48902, 48880, 48858, 48836, 48814, 48791, 48769, 48747, 48725, 48703, 48681, 48659, 48636, 48614, 48592, 48570, 48548, 48526, 48503, 48481, 48459, 48437, 48415, 48392, 48370, 48348, 48326, 48303, 48281, 48259, 48237, 48214, 48192, 48170, 48148, 48125, 48103, 48081, 48058, 48036, 48014, 47992, 47969, 47947, 47925, 47902, 47880, 47858, 47835, 47813, 47790, 47768, 47746, 47723, 47701, 47679, 47656, 47634, 47611, 47589, 47567, 47544, 47522, 47499, 47477, 47454, 47432, 47409, 47387, 47365, 47342, 47320, 47297, 47275, 47252, 47230, 47207, 47185, 47162, 47140, 47117, 47095, 47072, 47049, 47027, 47004, 46982, 46959, 46937, 46914, 46891, 46869, 46846, 46824, 46801, 46778, 46756, 46733, 46711, 46688, 46665, 46643, 46620, 46597, 46575, 46552, 46529, 46507, 46484, 46461, 46438, 46416, 46393, 46370, 46348, 46325, 46302, 46279, 46257, 46234, 46211, 46188, 46166, 46143, 46120, 46097, 46074, 46052, 46029, 46006, 45983, 45960, 45937, 45915, 45892, 45869, 45846, 45823, 45800, 45777, 45754, 45731, 45709, 45686, 45663, 45640, 45617, 45594, 45571, 45548, 45525, 45502, 45479, 45456, 45433, 45410, 45387, 45364, 45341, 45318, 45295, 45272, 45249, 45226, 45203, 45180, 45157, 45134, 45111, 45088, 45065, 45041, 45018, 44995, 44972, 44949, 44926, 44903, 44880, 44856, 44833, 44810, 44787, 44764, 44741, 44717, 44694, 44671, 44648, 44624, 44601, 44578, 44555, 44531, 44508, 44485, 44462, 44438, 44415, 44392, 44369, 44345, 44322, 44299, 44275, 44252, 44229, 44205, 44182, 44158, 44135, 44112, 44088, 44065, 44041, 44018, 43995, 43971, 43948, 43924, 43901, 43877, 43854, 43831, 43807, 43784, 43760, 43737, 43713, 43690, 43666, 43642, 43619, 43595, 43572, 43548, 43525, 43501, 43477, 43454, 43430, 43407, 43383, 43359, 43336, 43312, 43288, 43265, 43241, 43217, 43194, 43170, 43146, 43123, 43099, 43075, 43052, 43028, 43004, 42980, 42957, 42933, 42909, 42885, 42861, 42838, 42814, 42790, 42766, 42742, 42718, 42695, 42671, 42647, 42623, 42599, 42575, 42551, 42527, 42503, 42480, 42456, 42432, 42408, 42384, 42360, 42336, 42312, 42288, 42264, 42240, 42216, 42192, 42168, 42144, 42120, 42095, 42071, 42047, 42023, 41999, 41975, 41951, 41927, 41903, 41878, 41854, 41830, 41806, 41782, 41758, 41733, 41709, 41685, 41661, 41637, 41612, 41588, 41564, 41540, 41515, 41491, 41467, 41442, 41418, 41394, 41369, 41345, 41321, 41296, 41272, 41248, 41223, 41199, 41174, 41150, 41125, 41101, 41077, 41052, 41028, 41003, 40979, 40954, 40930, 40905, 40881, 40856, 40832, 40807, 40782, 40758, 40733, 40709, 40684, 40659, 40635, 40610, 40586, 40561, 40536, 40512, 40487, 40462, 40437, 40413, 40388, 40363, 40339, 40314, 40289, 40264, 40239, 40215, 40190, 40165, 40140, 40115, 40091, 40066, 40041, 40016, 39991, 39966, 39941, 39916, 39891, 39866, 39842, 39817, 39792, 39767, 39742, 39717, 39692, 39667, 39642, 39616, 39591, 39566, 39541, 39516, 39491, 39466, 39441, 39416, 39391, 39365, 39340, 39315, 39290, 39265, 39239, 39214, 39189, 39164, 39139, 39113, 39088, 39063, 39037, 39012, 38987, 38961, 38936, 38911, 38885, 38860, 38835, 38809, 38784, 38758, 38733, 38707, 38682, 38657, 38631, 38606, 38580, 38554, 38529, 38503, 38478, 38452, 38427, 38401, 38376, 38350, 38324, 38299, 38273, 38247, 38222, 38196, 38170, 38145, 38119, 38093, 38067, 38042, 38016, 37990, 37964, 37938, 37913, 37887, 37861, 37835, 37809, 37783, 37757, 37732, 37706, 37680, 37654, 37628, 37602, 37576, 37550, 37524, 37498, 37472, 37446, 37420, 37394, 37367, 37341, 37315, 37289, 37263, 37237, 37211, 37184, 37158, 37132, 37106, 37080, 37053, 37027, 37001, 36974, 36948, 36922, 36896, 36869, 36843, 36816, 36790, 36764, 36737, 36711, 36684, 36658, 36631, 36605, 36579, 36552, 36525, 36499, 36472, 36446, 36419, 36393, 36366, 36339, 36313, 36286, 36259, 36233, 36206, 36179, 36153, 36126, 36099, 36072, 36046, 36019, 35992, 35965, 35938, 35911, 35885, 35858, 35831, 35804, 35777, 35750, 35723, 35696, 35669, 35642, 35615, 35588, 35561, 35534, 35507, 35480, 35453, 35426, 35398, 35371, 35344, 35317, 35290, 35262, 35235, 35208, 35181, 35153, 35126, 35099, 35071, 35044, 35017, 34989, 34962, 34934, 34907, 34880, 34852, 34825, 34797, 34770, 34742, 34715, 34687, 34659, 34632, 34604, 34577, 34549, 34521, 34494, 34466, 34438, 34410, 34383, 34355, 34327, 34299, 34272, 34244, 34216, 34188, 34160, 34132, 34104, 34076, 34048, 34020, 33992, 33964, 33936, 33908, 33880, 33852, 33824, 33796, 33768, 33740, 33712, 33683, 33655, 33627, 33599, 33570, 33542, 33514, 33486, 33457, 33429, 33400, 33372, 33344, 33315, 33287, 33258, 33230, 33201, 33173, 33144, 33116, 33087, 33059, 33030, 33001, 32973, 32944, 32915, 32887, 32858, 32829};
const unsigned int arctan_table[ARCTAN_TABLE_SIZE] = {0, 20, 40, 61, 81, 101, 122, 142, 163, 183, 203, 224, 244, 265, 285, 305, 326, 346, 367, 387, 407, 428, 448, 468, 489, 509, 530, 550, 570, 591, 611, 631, 652, 672, 693, 713, 733, 754, 774, 794, 815, 835, 855, 876, 896, 917, 937, 957, 978, 998, 1018, 1039, 1059, 1079, 1100, 1120, 1140, 1161, 1181, 1201, 1222, 1242, 1262, 1283, 1303, 1323, 1343, 1364, 1384, 1404, 1425, 1445, 1465, 1486, 1506, 1526, 1546, 1567, 1587, 1607, 1628, 1648, 1668, 1688, 1709, 1729, 1749, 1769, 1790, 1810, 1830, 1850, 1870, 1891, 1911, 1931, 1951, 1972, 1992, 2012, 2032, 2052, 2073, 2093, 2113, 2133, 2153, 2173, 2194, 2214, 2234, 2254, 2274, 2294, 2315, 2335, 2355, 2375, 2395, 2415, 2435, 2455, 2476, 2496, 2516, 2536, 2556, 2576, 2596, 2616, 2636, 2656, 2676, 2696, 2716, 2737, 2757, 2777, 2797, 2817, 2837, 2857, 2877, 2897, 2917, 2937, 2957, 2977, 2997, 3017, 3037, 3057, 3076, 3096, 3116, 3136, 3156, 3176, 3196, 3216, 3236, 3256, 3276, 3296, 3315, 3335, 3355, 3375, 3395, 3415, 3435, 3454, 3474, 3494, 3514, 3534, 3554, 3573, 3593, 3613, 3633, 3653, 3672, 3692, 3712, 3732, 3751, 3771, 3791, 3811, 3830, 3850, 3870, 3889, 3909, 3929, 3948, 3968, 3988, 4007, 4027, 4047, 4066, 4086, 4105, 4125, 4145, 4164, 4184, 4203, 4223, 4243, 4262, 4282, 4301, 4321, 4340, 4360, 4379, 4399, 4418, 4438, 4457, 4477, 4496, 4516, 4535, 4555, 4574, 4593, 4613, 4632, 4652, 4671, 4690, 4710, 4729, 4748, 4768, 4787, 4807, 4826, 4845, 4864, 4884, 4903, 4922, 4942, 4961, 4980, 4999, 5019, 5038, 5057, 5076, 5095, 5115, 5134, 5153, 5172, 5191, 5210, 5230, 5249, 5268, 5287, 5306, 5325, 5344, 5363, 5382, 5401, 5421, 5440, 5459, 5478, 5497, 5516, 5535, 5554, 5573, 5592, 5611, 5629, 5648, 5667, 5686, 5705, 5724, 5743, 5762, 5781, 5800, 5818, 5837, 5856, 5875, 5894, 5913, 5931, 5950, 5969, 5988, 6006, 6025, 6044, 6063, 6081, 6100, 6119, 6137, 6156, 6175, 6193, 6212, 6231, 6249, 6268, 6286, 6305, 6324, 6342, 6361, 6379, 6398, 6416, 6435, 6453, 6472, 6490, 6509, 6527, 6546, 6564, 6583, 6601, 6619, 6638, 6656, 6675, 6693, 6711, 6730, 6748, 6766, 6785, 6803, 6821, 6840, 6858, 6876, 6894, 6913, 6931, 6949, 6967, 6985, 7004, 7022, 7040, 7058, 7076, 7094, 7112, 7131, 7149, 7167, 7185, 7203, 7221, 7239, 7257, 7275, 7293, 7311, 7329, 7347, 7365, 7383, 7401, 7419, 7437, 7455, 7472, 7490, 7508, 7526, 7544, 7562, 7580, 7597, 7615, 7633, 7651, 7668, 7686, 7704, 7722, 7739, 7757, 7775, 7792, 7810, 7828, 7845, 7863, 7881, 7898, 7916, 7934, 7951, 7969, 7986, 8004, 8021, 8039, 8056, 8074, 8091, 8109, 8126, 8144, 8161, 8178, 8196, 8213, 8231, 8248, 8265, 8283, 8300, 8317, 8335, 8352, 8369, 8387, 8404, 8421, 8438, 8456, 8473, 8490, 8507, 8524, 8542, 8559, 8576, 8593, 8610, 8627, 8644, 8661, 8678, 8695, 8712, 8730, 8747, 8764, 8781, 8798, 8814, 8831, 8848, 8865, 8882, 8899, 8916, 8933, 8950, 8967, 8983, 9000, 9017, 9034, 9051, 9068, 9084, 9101, 9118, 9135, 9151, 9168, 9185, 9201, 9218, 9235, 9251, 9268, 9285, 9301, 9318, 9334, 9351, 9367, 9384, 9400, 9417, 9434, 9450, 9466, 9483, 9499, 9516, 9532, 9549, 9565, 9581, 9598, 9614, 9631, 9647, 9663, 9680, 9696, 9712, 9728, 9745, 9761, 9777, 9793, 9810, 9826, 9842, 9858, 9874, 9890, 9907, 9923, 9939, 9955, 9971, 9987, 10003, 10019, 10035, 10051, 10067, 10083, 10099, 10115, 10131, 10147, 10163, 10179, 10195, 10211, 10227, 10242, 10258, 10274, 10290, 10306, 10322, 10337, 10353, 10369, 10385, 10400, 10416, 10432, 10447, 10463, 10479, 10495, 10510, 10526, 10541, 10557, 10573, 10588, 10604, 10619, 10635, 10650, 10666, 10681, 10697, 10712, 10728, 10743, 10759, 10774, 10790, 10805, 10820, 10836, 10851, 10866, 10882, 10897, 10912, 10928, 10943, 10958, 10973, 10989, 11004, 11019, 11034, 11050, 11065, 11080, 11095, 11110, 11125, 11140, 11156, 11171, 11186, 11201, 11216, 11231, 11246, 11261, 11276, 11291, 11306, 11321, 11336, 11351, 11366, 11381, 11395, 11410, 11425, 11440, 11455, 11470, 11484, 11499, 11514, 11529, 11544, 11558, 11573, 11588, 11603, 11617, 11632, 11647, 11661, 11676, 11691, 11705, 11720, 11734, 11749, 11764, 11778, 11793, 11807, 11822, 11836, 11851, 11865, 11880, 11894, 11909, 11923, 11937, 11952, 11966, 11981, 11995, 12009, 12024, 12038, 12052, 12067, 12081, 12095, 12109, 12124, 12138, 12152, 12166, 12181, 12195, 12209, 12223, 12237, 12251, 12265, 12280, 12294, 12308, 12322, 12336, 12350, 12364, 12378, 12392, 12406, 12420, 12434, 12448, 12462, 12476, 12490, 12504, 12518, 12531, 12545, 12559, 12573, 12587, 12601, 12614, 12628, 12642, 12656, 12670, 12683, 12697, 12711, 12724, 12738, 12752, 12765, 12779, 12793, 12806, 12820, 12834, 12847, 12861, 12874, 12888, 12901, 12915, 12929, 12942, 12956, 12969, 12982, 12996, 13009, 13023, 13036, 13050, 13063, 13076, 13090, 13103, 13116, 13130, 13143, 13156, 13170, 13183, 13196, 13210, 13223, 13236, 13249, 13262, 13276, 13289, 13302, 13315, 13328, 13341, 13355, 13368, 13381, 13394, 13407, 13420, 13433, 13446, 13459, 13472, 13485, 13498, 13511, 13524, 13537, 13550, 13563, 13576, 13589, 13602, 13614, 13627, 13640, 13653, 13666, 13679, 13691, 13704, 13717, 13730, 13742, 13755, 13768, 13781, 13793, 13806, 13819, 13831, 13844, 13857, 13869, 13882, 13895, 13907, 13920, 13932, 13945, 13957, 13970, 13983, 13995, 14008, 14020, 14033, 14045, 14057, 14070, 14082, 14095, 14107, 14120, 14132, 14144, 14157, 14169, 14181, 14194, 14206, 14218, 14231, 14243, 14255, 14267, 14280, 14292, 14304, 14316, 14329, 14341, 14353, 14365, 14377, 14389, 14401, 14414, 14426, 14438, 14450, 14462, 14474, 14486, 14498, 14510, 14522, 14534, 14546, 14558, 14570, 14582, 14594, 14606, 14618, 14630, 14642, 14653, 14665, 14677, 14689, 14701, 14713, 14725, 14736, 14748, 14760, 14772, 14783, 14795, 14807, 14819, 14830, 14842, 14854, 14865, 14877, 14889, 14900, 14912, 14924, 14935, 14947, 14958, 14970, 14982, 14993, 15005, 15016, 15028, 15039, 15051, 15062, 15074, 15085, 15097, 15108, 15120, 15131, 15142, 15154, 15165, 15177, 15188, 15199, 15211, 15222, 15233, 15245, 15256, 15267, 15278, 15290, 15301, 15312, 15323, 15335, 15346, 15357, 15368, 15379, 15391, 15402, 15413, 15424, 15435, 15446, 15457, 15469, 15480, 15491, 15502, 15513, 15524, 15535, 15546, 15557, 15568, 15579, 15590, 15601, 15612, 15623, 15634, 15645, 15655, 15666, 15677, 15688, 15699, 15710, 15721, 15732, 15742, 15753, 15764, 15775, 15786, 15796, 15807, 15818, 15829, 15839, 15850, 15861, 15872, 15882, 15893, 15904, 15914, 15925, 15935, 15946, 15957, 15967, 15978, 15989, 15999, 16010, 16020, 16031, 16041, 16052, 16062, 16073, 16083, 16094, 16104, 16115, 16125, 16136, 16146, 16157, 16167, 16177, 16188, 16198, 16208, 16219, 16229, 16240, 16250, 16260, 16270, 16281, 16291, 16301, 16312, 16322, 16332, 16342, 16353, 16363, 16373, 16383};
volatile int run_test_pattern_flag = 0;
volatile int raw_x = 1023;       // Starting position for x
volatile int raw_y = 1023;       // Starting position for y

void init_servos() {
    _RCDIV = 0;
    __builtin_write_OSCCONL(OSCCON & 0xbf); // Unlock PPS
    RPOR7bits.RP14R = 18;                    // Map RP14 to OC1 (servo1)
    RPOR6bits.RP13R = 19;                   // Map RP13 to OC2 (servo2)
    __builtin_write_OSCCONL(OSCCON | 0x40); // Lock PPS

    AD1PCFG = 0xFFFF;                        // Set all pins digital
    TRISBbits.TRISB14 = 0;                   // Set RP14 to output (servo1)
    TRISBbits.TRISB13 = 0;                   // Set RP13 to output (servo2)

    TMR3 = 0;                                // Reset timer
    PR3 = SERVO_PERIOD;                      // Set period
    T3CON = 0x8010;                          // Enable TON, prescale x8

    OC1RS = (SERVO_PERIOD / 4);              // Full period
    OC1CON = 0x000E;                         // Set OC1 to PWM mode
    OC1CONbits.OCFLT = 0;                    // Clear flag    
    
    OC2RS = 0;
    OC2CON = 0x000E;
    OC2CONbits.OCFLT = 0;
}

void init_test_pattern_button() {
    // Use RB5 / Pin 14
    AD1PCFG |= 0x0020;
    TRISBbits.TRISB5 = 1;                   // Input            
    CNPU2bits.CN27PUE = 1;                  // Enable pullup resistor for RB5
    _RB5 = 0;
    __builtin_write_OSCCONL(OSCCON & 0xbf); // Unlock PPS
    RPINR7bits.IC1R = 5;                    // Map RP5 to IC1
    __builtin_write_OSCCONL(OSCCON | 0x40); // Lock PPS
    
    IC1CONbits.ICM = 0b011;                   // Only rising edges
    IFS0bits.IC1IF = 0;
    IEC0bits.IC1IE = 1;
}

void __attribute__((__interrupt__, auto_psv)) _IC1Interrupt(void) {
    IFS0bits.IC1IF = 0;                      // Clear the IC1 interrupt flag
    run_test_pattern_flag = 1;
}

void set_servo(unsigned int percent) {
    // Range of input is 0-65535
    // 0 degree position --> 1000
    // 180 degree position --> 5000
    
    // Need to convert that to 0-100% for the servo
    OC1RS = (unsigned int)(((unsigned long)percent*4000)/65535 + 1000);
}

void set_servo2(unsigned int percent) {
    // Range of input is 0-65535
    // 0 degree position --> 1000
    // 180 degree position --> 5000
    
    // Need to convert that to 0-100% for the servo
    OC2RS = (unsigned int)(((unsigned long)(65535-percent)*4000)/65535 + 1000);
}

unsigned int distance(unsigned int x, unsigned int y) {
    // x and y from [0,1023]
    unsigned int n0 = MAX(x,y); // Take max (1 cycle)
    n0 *= 39;
    n0 = (n0 >> 5); // Divide by 32
    // Now we have our initial guess, 1.21875 times the max
    // Time to find number to take sqrt of
    unsigned long N = (unsigned long)x*x + (unsigned long)y*y;
    // Could split this part into its own sqrt function
    unsigned long dividend = (unsigned long)n0*((N*3+(unsigned long)n0*n0) >> 2);
    unsigned int divisor = MAX(((N + (unsigned long)3*n0*n0) >> 7),1);
    unsigned int result = ((dividend/divisor) >> 5);
    
    return result;
}

unsigned int calculate_inner_angle(unsigned int x, unsigned int y) {
    return inner_angle_table[distance(x,y)];
}

unsigned int calculate_arctan_index(unsigned int x, unsigned int y) {
    return (((long)y << 16) / MAX(x, 1) * (ARCTAN_TABLE_SIZE - 1)) >> 16;
}

unsigned int calculate_outer_angle(unsigned int x, unsigned int y) {
    // The goal is to always keep (y/x) or (x/y) under 1. We can use trig identities to flip these around.
    if (y < x) {
        return 0x8000 + arctan_table[calculate_arctan_index(x,y)] - (calculate_inner_angle(x,y) >> 1);
    }
    return 0x0000 - arctan_table[calculate_arctan_index(y,x)] - (calculate_inner_angle(x,y) >> 1);
}

void move_to(int new_x, int new_y, int cycles_to_travel) {
    // Draws a point to point line from the current position to the new position
    // Can't just divide because no floating point :(
    // So we scale up by the remaining amount: the max absolute value is 1023 = 2^10, so we have 15-10 = 5 bits left to work with.
    // This function also cannibalizes the main loop, so be careful using it. Only intended for test patterns.
    int distance_x = ((raw_x - new_x) << 5);
    int distance_y = ((raw_y - new_y) << 5);
    
    int temp_x = raw_x;
    int temp_y = raw_y;
    
    for (int i = 0 ; i < cycles_to_travel; i++) {
        raw_x -= ((distance_x/cycles_to_travel * i) >> 5);
        raw_y -= ((distance_y/cycles_to_travel * i) >> 5);
        
        update_servo_angles(1);
        
        raw_x = temp_x;
        raw_y = temp_y;
        
        delay_ms(DELAY_TIME); // Wait
        LATBbits.LATB15 ^= 1; // Toggle RB15 (heartbeat LED)
    }
    
    raw_x = new_x;
    raw_y = new_y;
}

void update_servo_angles(int print_to_lcd) {
    // Limit x to the range [64, 512]
    int x = MAX(X_OFFSET, raw_x);
    int y = raw_y;
    
    unsigned int inner_angle = calculate_inner_angle(x,y);
    unsigned int outer_angle = calculate_outer_angle(x,y);

    // Process values and store them in buffers
    put_val_inner(inner_angle);
    put_val_outer(outer_angle);

    // If the buffer contains valid data, set the servos
    if (inner_buffer[AVERAGE_COUNT] != 0) {
        set_servo(outer_average);
        set_servo2(inner_average);
    }
    
    // Display servo info if requested
    if (print_to_lcd) {
        lcd_clear();
        lcd_set_cursor(0,0); // Move to first line, divide by 364 for angle in degrees

        // Print outer angle
        lcd_print_int(outer_angle);

        lcd_set_cursor(2,0); // Move to second line
        lcd_print_int(inner_angle);

        // Print inner angle
        lcd_set_cursor(4,0); // Move to third line (need to fix setCursor)

        // Print coordinates
        lcd_print_int(x);
        lcd_print_char(',');
        lcd_print_char(' ');
        lcd_print_int(y);     
        
        lcd_set_cursor(6,0); // Move to third line (need to fix setCursor)

        // Print coordinates
        lcd_print_int(raw_x);
        lcd_print_char(',');
        lcd_print_char(' ');
        lcd_print_int(raw_y);     
    }
}

void run_test_pattern() {
    for (int i = 0; i < 5; i++) { 
        // Square
        move_to(693,693,CYCLES_TO_TRAVEL);
        move_to(331,693,CYCLES_TO_TRAVEL);
        move_to(331,331,CYCLES_TO_TRAVEL);
        move_to(693,331,CYCLES_TO_TRAVEL);


        //Circle (16-point)
//        move_to(693,693,CYCLES_TO_TRAVEL);
//        move_to(609, 748, CYCLES_TO_TRAVEL);
//        move_to(512, 768, CYCLES_TO_TRAVEL);
//        move_to(414, 748, CYCLES_TO_TRAVEL);
//        move_to(330, 693, CYCLES_TO_TRAVEL);
//        move_to(275, 609, CYCLES_TO_TRAVEL);
//        move_to(256, 512, CYCLES_TO_TRAVEL);
//        move_to(275, 414, CYCLES_TO_TRAVEL);
//        move_to(330, 330, CYCLES_TO_TRAVEL);
//        move_to(414, 275, CYCLES_TO_TRAVEL);
//        move_to(511, 256, CYCLES_TO_TRAVEL);
//        move_to(609, 275, CYCLES_TO_TRAVEL);
//        move_to(693, 330, CYCLES_TO_TRAVEL);
//        move_to(748, 414, CYCLES_TO_TRAVEL);
//        move_to(768, 512, CYCLES_TO_TRAVEL);
//        move_to(748, 609, CYCLES_TO_TRAVEL);
//        move_to(693, 693, CYCLES_TO_TRAVEL);
        
        // Horizontal Line
//        move_to(1023, 512, CYCLES_TO_TRAVEL);
//        move_to(128, 512, CYCLES_TO_TRAVEL);
    }
}

volatile int get_raw_x(void){
    return raw_x;
}

volatile int get_raw_y(void){
    return raw_y;
=======
/*
 * File:   troth004_plotter_library.c
 * Author: ryoth
 *
 * Created on November 11, 2024, 10:19 AM
 */


#include "xc.h"
#include "troth004_utils.h"
#include "troth004_lcd_library_v1.h"
#include "troth004_plotter_library_v1.h"

#define ARCTAN_TABLE_SIZE 1024

const unsigned int inner_angle_table[1447] = {65535, 65514, 65494, 65473, 65453, 65433, 65412, 65392, 65372, 65351, 65331, 65310, 65290, 65270, 65249, 65229, 65209, 65188, 65168, 65147, 65127, 65107, 65086, 65066, 65046, 65025, 65005, 64984, 64964, 64944, 64923, 64903, 64883, 64862, 64842, 64821, 64801, 64781, 64760, 64740, 64720, 64699, 64679, 64658, 64638, 64618, 64597, 64577, 64557, 64536, 64516, 64495, 64475, 64455, 64434, 64414, 64394, 64373, 64353, 64332, 64312, 64292, 64271, 64251, 64231, 64210, 64190, 64169, 64149, 64129, 64108, 64088, 64067, 64047, 64027, 64006, 63986, 63966, 63945, 63925, 63904, 63884, 63864, 63843, 63823, 63802, 63782, 63762, 63741, 63721, 63700, 63680, 63660, 63639, 63619, 63599, 63578, 63558, 63537, 63517, 63497, 63476, 63456, 63435, 63415, 63395, 63374, 63354, 63333, 63313, 63293, 63272, 63252, 63231, 63211, 63191, 63170, 63150, 63129, 63109, 63089, 63068, 63048, 63027, 63007, 62986, 62966, 62946, 62925, 62905, 62884, 62864, 62844, 62823, 62803, 62782, 62762, 62742, 62721, 62701, 62680, 62660, 62639, 62619, 62599, 62578, 62558, 62537, 62517, 62496, 62476, 62456, 62435, 62415, 62394, 62374, 62353, 62333, 62313, 62292, 62272, 62251, 62231, 62210, 62190, 62170, 62149, 62129, 62108, 62088, 62067, 62047, 62026, 62006, 61986, 61965, 61945, 61924, 61904, 61883, 61863, 61842, 61822, 61802, 61781, 61761, 61740, 61720, 61699, 61679, 61658, 61638, 61617, 61597, 61576, 61556, 61536, 61515, 61495, 61474, 61454, 61433, 61413, 61392, 61372, 61351, 61331, 61310, 61290, 61269, 61249, 61228, 61208, 61188, 61167, 61147, 61126, 61106, 61085, 61065, 61044, 61024, 61003, 60983, 60962, 60942, 60921, 60901, 60880, 60860, 60839, 60819, 60798, 60778, 60757, 60737, 60716, 60696, 60675, 60655, 60634, 60614, 60593, 60573, 60552, 60531, 60511, 60490, 60470, 60449, 60429, 60408, 60388, 60367, 60347, 60326, 60306, 60285, 60265, 60244, 60224, 60203, 60182, 60162, 60141, 60121, 60100, 60080, 60059, 60039, 60018, 59998, 59977, 59956, 59936, 59915, 59895, 59874, 59854, 59833, 59813, 59792, 59771, 59751, 59730, 59710, 59689, 59669, 59648, 59627, 59607, 59586, 59566, 59545, 59525, 59504, 59483, 59463, 59442, 59422, 59401, 59380, 59360, 59339, 59319, 59298, 59277, 59257, 59236, 59216, 59195, 59174, 59154, 59133, 59113, 59092, 59071, 59051, 59030, 59009, 58989, 58968, 58948, 58927, 58906, 58886, 58865, 58844, 58824, 58803, 58782, 58762, 58741, 58721, 58700, 58679, 58659, 58638, 58617, 58597, 58576, 58555, 58535, 58514, 58493, 58473, 58452, 58431, 58411, 58390, 58369, 58349, 58328, 58307, 58287, 58266, 58245, 58225, 58204, 58183, 58162, 58142, 58121, 58100, 58080, 58059, 58038, 58018, 57997, 57976, 57955, 57935, 57914, 57893, 57873, 57852, 57831, 57810, 57790, 57769, 57748, 57727, 57707, 57686, 57665, 57645, 57624, 57603, 57582, 57562, 57541, 57520, 57499, 57479, 57458, 57437, 57416, 57395, 57375, 57354, 57333, 57312, 57292, 57271, 57250, 57229, 57209, 57188, 57167, 57146, 57125, 57105, 57084, 57063, 57042, 57021, 57001, 56980, 56959, 56938, 56917, 56897, 56876, 56855, 56834, 56813, 56792, 56772, 56751, 56730, 56709, 56688, 56667, 56647, 56626, 56605, 56584, 56563, 56542, 56521, 56501, 56480, 56459, 56438, 56417, 56396, 56375, 56355, 56334, 56313, 56292, 56271, 56250, 56229, 56208, 56187, 56167, 56146, 56125, 56104, 56083, 56062, 56041, 56020, 55999, 55978, 55957, 55937, 55916, 55895, 55874, 55853, 55832, 55811, 55790, 55769, 55748, 55727, 55706, 55685, 55664, 55643, 55622, 55601, 55581, 55560, 55539, 55518, 55497, 55476, 55455, 55434, 55413, 55392, 55371, 55350, 55329, 55308, 55287, 55266, 55245, 55224, 55203, 55182, 55161, 55140, 55119, 55098, 55077, 55056, 55035, 55013, 54992, 54971, 54950, 54929, 54908, 54887, 54866, 54845, 54824, 54803, 54782, 54761, 54740, 54719, 54698, 54677, 54655, 54634, 54613, 54592, 54571, 54550, 54529, 54508, 54487, 54466, 54444, 54423, 54402, 54381, 54360, 54339, 54318, 54297, 54275, 54254, 54233, 54212, 54191, 54170, 54149, 54127, 54106, 54085, 54064, 54043, 54022, 54000, 53979, 53958, 53937, 53916, 53895, 53873, 53852, 53831, 53810, 53789, 53767, 53746, 53725, 53704, 53682, 53661, 53640, 53619, 53598, 53576, 53555, 53534, 53513, 53491, 53470, 53449, 53428, 53406, 53385, 53364, 53343, 53321, 53300, 53279, 53257, 53236, 53215, 53194, 53172, 53151, 53130, 53108, 53087, 53066, 53044, 53023, 53002, 52980, 52959, 52938, 52916, 52895, 52874, 52852, 52831, 52810, 52788, 52767, 52746, 52724, 52703, 52681, 52660, 52639, 52617, 52596, 52575, 52553, 52532, 52510, 52489, 52467, 52446, 52425, 52403, 52382, 52360, 52339, 52318, 52296, 52275, 52253, 52232, 52210, 52189, 52167, 52146, 52124, 52103, 52081, 52060, 52038, 52017, 51996, 51974, 51953, 51931, 51910, 51888, 51866, 51845, 51823, 51802, 51780, 51759, 51737, 51716, 51694, 51673, 51651, 51630, 51608, 51586, 51565, 51543, 51522, 51500, 51479, 51457, 51435, 51414, 51392, 51371, 51349, 51327, 51306, 51284, 51263, 51241, 51219, 51198, 51176, 51154, 51133, 51111, 51089, 51068, 51046, 51024, 51003, 50981, 50959, 50938, 50916, 50894, 50873, 50851, 50829, 50808, 50786, 50764, 50742, 50721, 50699, 50677, 50655, 50634, 50612, 50590, 50568, 50547, 50525, 50503, 50481, 50460, 50438, 50416, 50394, 50372, 50351, 50329, 50307, 50285, 50263, 50242, 50220, 50198, 50176, 50154, 50132, 50111, 50089, 50067, 50045, 50023, 50001, 49979, 49958, 49936, 49914, 49892, 49870, 49848, 49826, 49804, 49782, 49760, 49739, 49717, 49695, 49673, 49651, 49629, 49607, 49585, 49563, 49541, 49519, 49497, 49475, 49453, 49431, 49409, 49387, 49365, 49343, 49321, 49299, 49277, 49255, 49233, 49211, 49189, 49167, 49145, 49123, 49101, 49079, 49057, 49035, 49013, 48990, 48968, 48946, 48924, 48902, 48880, 48858, 48836, 48814, 48791, 48769, 48747, 48725, 48703, 48681, 48659, 48636, 48614, 48592, 48570, 48548, 48526, 48503, 48481, 48459, 48437, 48415, 48392, 48370, 48348, 48326, 48303, 48281, 48259, 48237, 48214, 48192, 48170, 48148, 48125, 48103, 48081, 48058, 48036, 48014, 47992, 47969, 47947, 47925, 47902, 47880, 47858, 47835, 47813, 47790, 47768, 47746, 47723, 47701, 47679, 47656, 47634, 47611, 47589, 47567, 47544, 47522, 47499, 47477, 47454, 47432, 47409, 47387, 47365, 47342, 47320, 47297, 47275, 47252, 47230, 47207, 47185, 47162, 47140, 47117, 47095, 47072, 47049, 47027, 47004, 46982, 46959, 46937, 46914, 46891, 46869, 46846, 46824, 46801, 46778, 46756, 46733, 46711, 46688, 46665, 46643, 46620, 46597, 46575, 46552, 46529, 46507, 46484, 46461, 46438, 46416, 46393, 46370, 46348, 46325, 46302, 46279, 46257, 46234, 46211, 46188, 46166, 46143, 46120, 46097, 46074, 46052, 46029, 46006, 45983, 45960, 45937, 45915, 45892, 45869, 45846, 45823, 45800, 45777, 45754, 45731, 45709, 45686, 45663, 45640, 45617, 45594, 45571, 45548, 45525, 45502, 45479, 45456, 45433, 45410, 45387, 45364, 45341, 45318, 45295, 45272, 45249, 45226, 45203, 45180, 45157, 45134, 45111, 45088, 45065, 45041, 45018, 44995, 44972, 44949, 44926, 44903, 44880, 44856, 44833, 44810, 44787, 44764, 44741, 44717, 44694, 44671, 44648, 44624, 44601, 44578, 44555, 44531, 44508, 44485, 44462, 44438, 44415, 44392, 44369, 44345, 44322, 44299, 44275, 44252, 44229, 44205, 44182, 44158, 44135, 44112, 44088, 44065, 44041, 44018, 43995, 43971, 43948, 43924, 43901, 43877, 43854, 43831, 43807, 43784, 43760, 43737, 43713, 43690, 43666, 43642, 43619, 43595, 43572, 43548, 43525, 43501, 43477, 43454, 43430, 43407, 43383, 43359, 43336, 43312, 43288, 43265, 43241, 43217, 43194, 43170, 43146, 43123, 43099, 43075, 43052, 43028, 43004, 42980, 42957, 42933, 42909, 42885, 42861, 42838, 42814, 42790, 42766, 42742, 42718, 42695, 42671, 42647, 42623, 42599, 42575, 42551, 42527, 42503, 42480, 42456, 42432, 42408, 42384, 42360, 42336, 42312, 42288, 42264, 42240, 42216, 42192, 42168, 42144, 42120, 42095, 42071, 42047, 42023, 41999, 41975, 41951, 41927, 41903, 41878, 41854, 41830, 41806, 41782, 41758, 41733, 41709, 41685, 41661, 41637, 41612, 41588, 41564, 41540, 41515, 41491, 41467, 41442, 41418, 41394, 41369, 41345, 41321, 41296, 41272, 41248, 41223, 41199, 41174, 41150, 41125, 41101, 41077, 41052, 41028, 41003, 40979, 40954, 40930, 40905, 40881, 40856, 40832, 40807, 40782, 40758, 40733, 40709, 40684, 40659, 40635, 40610, 40586, 40561, 40536, 40512, 40487, 40462, 40437, 40413, 40388, 40363, 40339, 40314, 40289, 40264, 40239, 40215, 40190, 40165, 40140, 40115, 40091, 40066, 40041, 40016, 39991, 39966, 39941, 39916, 39891, 39866, 39842, 39817, 39792, 39767, 39742, 39717, 39692, 39667, 39642, 39616, 39591, 39566, 39541, 39516, 39491, 39466, 39441, 39416, 39391, 39365, 39340, 39315, 39290, 39265, 39239, 39214, 39189, 39164, 39139, 39113, 39088, 39063, 39037, 39012, 38987, 38961, 38936, 38911, 38885, 38860, 38835, 38809, 38784, 38758, 38733, 38707, 38682, 38657, 38631, 38606, 38580, 38554, 38529, 38503, 38478, 38452, 38427, 38401, 38376, 38350, 38324, 38299, 38273, 38247, 38222, 38196, 38170, 38145, 38119, 38093, 38067, 38042, 38016, 37990, 37964, 37938, 37913, 37887, 37861, 37835, 37809, 37783, 37757, 37732, 37706, 37680, 37654, 37628, 37602, 37576, 37550, 37524, 37498, 37472, 37446, 37420, 37394, 37367, 37341, 37315, 37289, 37263, 37237, 37211, 37184, 37158, 37132, 37106, 37080, 37053, 37027, 37001, 36974, 36948, 36922, 36896, 36869, 36843, 36816, 36790, 36764, 36737, 36711, 36684, 36658, 36631, 36605, 36579, 36552, 36525, 36499, 36472, 36446, 36419, 36393, 36366, 36339, 36313, 36286, 36259, 36233, 36206, 36179, 36153, 36126, 36099, 36072, 36046, 36019, 35992, 35965, 35938, 35911, 35885, 35858, 35831, 35804, 35777, 35750, 35723, 35696, 35669, 35642, 35615, 35588, 35561, 35534, 35507, 35480, 35453, 35426, 35398, 35371, 35344, 35317, 35290, 35262, 35235, 35208, 35181, 35153, 35126, 35099, 35071, 35044, 35017, 34989, 34962, 34934, 34907, 34880, 34852, 34825, 34797, 34770, 34742, 34715, 34687, 34659, 34632, 34604, 34577, 34549, 34521, 34494, 34466, 34438, 34410, 34383, 34355, 34327, 34299, 34272, 34244, 34216, 34188, 34160, 34132, 34104, 34076, 34048, 34020, 33992, 33964, 33936, 33908, 33880, 33852, 33824, 33796, 33768, 33740, 33712, 33683, 33655, 33627, 33599, 33570, 33542, 33514, 33486, 33457, 33429, 33400, 33372, 33344, 33315, 33287, 33258, 33230, 33201, 33173, 33144, 33116, 33087, 33059, 33030, 33001, 32973, 32944, 32915, 32887, 32858, 32829};
const unsigned int arctan_table[ARCTAN_TABLE_SIZE] = {0, 20, 40, 61, 81, 101, 122, 142, 163, 183, 203, 224, 244, 265, 285, 305, 326, 346, 367, 387, 407, 428, 448, 468, 489, 509, 530, 550, 570, 591, 611, 631, 652, 672, 693, 713, 733, 754, 774, 794, 815, 835, 855, 876, 896, 917, 937, 957, 978, 998, 1018, 1039, 1059, 1079, 1100, 1120, 1140, 1161, 1181, 1201, 1222, 1242, 1262, 1283, 1303, 1323, 1343, 1364, 1384, 1404, 1425, 1445, 1465, 1486, 1506, 1526, 1546, 1567, 1587, 1607, 1628, 1648, 1668, 1688, 1709, 1729, 1749, 1769, 1790, 1810, 1830, 1850, 1870, 1891, 1911, 1931, 1951, 1972, 1992, 2012, 2032, 2052, 2073, 2093, 2113, 2133, 2153, 2173, 2194, 2214, 2234, 2254, 2274, 2294, 2315, 2335, 2355, 2375, 2395, 2415, 2435, 2455, 2476, 2496, 2516, 2536, 2556, 2576, 2596, 2616, 2636, 2656, 2676, 2696, 2716, 2737, 2757, 2777, 2797, 2817, 2837, 2857, 2877, 2897, 2917, 2937, 2957, 2977, 2997, 3017, 3037, 3057, 3076, 3096, 3116, 3136, 3156, 3176, 3196, 3216, 3236, 3256, 3276, 3296, 3315, 3335, 3355, 3375, 3395, 3415, 3435, 3454, 3474, 3494, 3514, 3534, 3554, 3573, 3593, 3613, 3633, 3653, 3672, 3692, 3712, 3732, 3751, 3771, 3791, 3811, 3830, 3850, 3870, 3889, 3909, 3929, 3948, 3968, 3988, 4007, 4027, 4047, 4066, 4086, 4105, 4125, 4145, 4164, 4184, 4203, 4223, 4243, 4262, 4282, 4301, 4321, 4340, 4360, 4379, 4399, 4418, 4438, 4457, 4477, 4496, 4516, 4535, 4555, 4574, 4593, 4613, 4632, 4652, 4671, 4690, 4710, 4729, 4748, 4768, 4787, 4807, 4826, 4845, 4864, 4884, 4903, 4922, 4942, 4961, 4980, 4999, 5019, 5038, 5057, 5076, 5095, 5115, 5134, 5153, 5172, 5191, 5210, 5230, 5249, 5268, 5287, 5306, 5325, 5344, 5363, 5382, 5401, 5421, 5440, 5459, 5478, 5497, 5516, 5535, 5554, 5573, 5592, 5611, 5629, 5648, 5667, 5686, 5705, 5724, 5743, 5762, 5781, 5800, 5818, 5837, 5856, 5875, 5894, 5913, 5931, 5950, 5969, 5988, 6006, 6025, 6044, 6063, 6081, 6100, 6119, 6137, 6156, 6175, 6193, 6212, 6231, 6249, 6268, 6286, 6305, 6324, 6342, 6361, 6379, 6398, 6416, 6435, 6453, 6472, 6490, 6509, 6527, 6546, 6564, 6583, 6601, 6619, 6638, 6656, 6675, 6693, 6711, 6730, 6748, 6766, 6785, 6803, 6821, 6840, 6858, 6876, 6894, 6913, 6931, 6949, 6967, 6985, 7004, 7022, 7040, 7058, 7076, 7094, 7112, 7131, 7149, 7167, 7185, 7203, 7221, 7239, 7257, 7275, 7293, 7311, 7329, 7347, 7365, 7383, 7401, 7419, 7437, 7455, 7472, 7490, 7508, 7526, 7544, 7562, 7580, 7597, 7615, 7633, 7651, 7668, 7686, 7704, 7722, 7739, 7757, 7775, 7792, 7810, 7828, 7845, 7863, 7881, 7898, 7916, 7934, 7951, 7969, 7986, 8004, 8021, 8039, 8056, 8074, 8091, 8109, 8126, 8144, 8161, 8178, 8196, 8213, 8231, 8248, 8265, 8283, 8300, 8317, 8335, 8352, 8369, 8387, 8404, 8421, 8438, 8456, 8473, 8490, 8507, 8524, 8542, 8559, 8576, 8593, 8610, 8627, 8644, 8661, 8678, 8695, 8712, 8730, 8747, 8764, 8781, 8798, 8814, 8831, 8848, 8865, 8882, 8899, 8916, 8933, 8950, 8967, 8983, 9000, 9017, 9034, 9051, 9068, 9084, 9101, 9118, 9135, 9151, 9168, 9185, 9201, 9218, 9235, 9251, 9268, 9285, 9301, 9318, 9334, 9351, 9367, 9384, 9400, 9417, 9434, 9450, 9466, 9483, 9499, 9516, 9532, 9549, 9565, 9581, 9598, 9614, 9631, 9647, 9663, 9680, 9696, 9712, 9728, 9745, 9761, 9777, 9793, 9810, 9826, 9842, 9858, 9874, 9890, 9907, 9923, 9939, 9955, 9971, 9987, 10003, 10019, 10035, 10051, 10067, 10083, 10099, 10115, 10131, 10147, 10163, 10179, 10195, 10211, 10227, 10242, 10258, 10274, 10290, 10306, 10322, 10337, 10353, 10369, 10385, 10400, 10416, 10432, 10447, 10463, 10479, 10495, 10510, 10526, 10541, 10557, 10573, 10588, 10604, 10619, 10635, 10650, 10666, 10681, 10697, 10712, 10728, 10743, 10759, 10774, 10790, 10805, 10820, 10836, 10851, 10866, 10882, 10897, 10912, 10928, 10943, 10958, 10973, 10989, 11004, 11019, 11034, 11050, 11065, 11080, 11095, 11110, 11125, 11140, 11156, 11171, 11186, 11201, 11216, 11231, 11246, 11261, 11276, 11291, 11306, 11321, 11336, 11351, 11366, 11381, 11395, 11410, 11425, 11440, 11455, 11470, 11484, 11499, 11514, 11529, 11544, 11558, 11573, 11588, 11603, 11617, 11632, 11647, 11661, 11676, 11691, 11705, 11720, 11734, 11749, 11764, 11778, 11793, 11807, 11822, 11836, 11851, 11865, 11880, 11894, 11909, 11923, 11937, 11952, 11966, 11981, 11995, 12009, 12024, 12038, 12052, 12067, 12081, 12095, 12109, 12124, 12138, 12152, 12166, 12181, 12195, 12209, 12223, 12237, 12251, 12265, 12280, 12294, 12308, 12322, 12336, 12350, 12364, 12378, 12392, 12406, 12420, 12434, 12448, 12462, 12476, 12490, 12504, 12518, 12531, 12545, 12559, 12573, 12587, 12601, 12614, 12628, 12642, 12656, 12670, 12683, 12697, 12711, 12724, 12738, 12752, 12765, 12779, 12793, 12806, 12820, 12834, 12847, 12861, 12874, 12888, 12901, 12915, 12929, 12942, 12956, 12969, 12982, 12996, 13009, 13023, 13036, 13050, 13063, 13076, 13090, 13103, 13116, 13130, 13143, 13156, 13170, 13183, 13196, 13210, 13223, 13236, 13249, 13262, 13276, 13289, 13302, 13315, 13328, 13341, 13355, 13368, 13381, 13394, 13407, 13420, 13433, 13446, 13459, 13472, 13485, 13498, 13511, 13524, 13537, 13550, 13563, 13576, 13589, 13602, 13614, 13627, 13640, 13653, 13666, 13679, 13691, 13704, 13717, 13730, 13742, 13755, 13768, 13781, 13793, 13806, 13819, 13831, 13844, 13857, 13869, 13882, 13895, 13907, 13920, 13932, 13945, 13957, 13970, 13983, 13995, 14008, 14020, 14033, 14045, 14057, 14070, 14082, 14095, 14107, 14120, 14132, 14144, 14157, 14169, 14181, 14194, 14206, 14218, 14231, 14243, 14255, 14267, 14280, 14292, 14304, 14316, 14329, 14341, 14353, 14365, 14377, 14389, 14401, 14414, 14426, 14438, 14450, 14462, 14474, 14486, 14498, 14510, 14522, 14534, 14546, 14558, 14570, 14582, 14594, 14606, 14618, 14630, 14642, 14653, 14665, 14677, 14689, 14701, 14713, 14725, 14736, 14748, 14760, 14772, 14783, 14795, 14807, 14819, 14830, 14842, 14854, 14865, 14877, 14889, 14900, 14912, 14924, 14935, 14947, 14958, 14970, 14982, 14993, 15005, 15016, 15028, 15039, 15051, 15062, 15074, 15085, 15097, 15108, 15120, 15131, 15142, 15154, 15165, 15177, 15188, 15199, 15211, 15222, 15233, 15245, 15256, 15267, 15278, 15290, 15301, 15312, 15323, 15335, 15346, 15357, 15368, 15379, 15391, 15402, 15413, 15424, 15435, 15446, 15457, 15469, 15480, 15491, 15502, 15513, 15524, 15535, 15546, 15557, 15568, 15579, 15590, 15601, 15612, 15623, 15634, 15645, 15655, 15666, 15677, 15688, 15699, 15710, 15721, 15732, 15742, 15753, 15764, 15775, 15786, 15796, 15807, 15818, 15829, 15839, 15850, 15861, 15872, 15882, 15893, 15904, 15914, 15925, 15935, 15946, 15957, 15967, 15978, 15989, 15999, 16010, 16020, 16031, 16041, 16052, 16062, 16073, 16083, 16094, 16104, 16115, 16125, 16136, 16146, 16157, 16167, 16177, 16188, 16198, 16208, 16219, 16229, 16240, 16250, 16260, 16270, 16281, 16291, 16301, 16312, 16322, 16332, 16342, 16353, 16363, 16373, 16383};
volatile int run_test_pattern_flag = 0;
volatile int raw_x = 1023;       // Starting position for x
volatile int raw_y = 1023;       // Starting position for y

void init_servos() {
    _RCDIV = 0;
    __builtin_write_OSCCONL(OSCCON & 0xbf); // Unlock PPS
    RPOR7bits.RP14R = 18;                    // Map RP14 to OC1 (servo1)
    RPOR6bits.RP13R = 19;                   // Map RP13 to OC2 (servo2)
    __builtin_write_OSCCONL(OSCCON | 0x40); // Lock PPS

    AD1PCFG = 0xFFFF;                        // Set all pins digital
    TRISBbits.TRISB14 = 0;                   // Set RP14 to output (servo1)
    TRISBbits.TRISB13 = 0;                   // Set RP13 to output (servo2)

    TMR3 = 0;                                // Reset timer
    PR3 = SERVO_PERIOD;                      // Set period
    T3CON = 0x8010;                          // Enable TON, prescale x8

    OC1RS = (SERVO_PERIOD / 4);              // Full period
    OC1CON = 0x000E;                         // Set OC1 to PWM mode
    OC1CONbits.OCFLT = 0;                    // Clear flag    
    
    OC2RS = 0;
    OC2CON = 0x000E;
    OC2CONbits.OCFLT = 0;
}

void init_test_pattern_button() {
    // Use RB5 / Pin 14
    AD1PCFG |= 0x0020;
    TRISBbits.TRISB5 = 1;                   // Input            
    CNPU2bits.CN27PUE = 1;                  // Enable pullup resistor for RB5
    _RB5 = 0;
    __builtin_write_OSCCONL(OSCCON & 0xbf); // Unlock PPS
    RPINR7bits.IC1R = 5;                    // Map RP5 to IC1
    __builtin_write_OSCCONL(OSCCON | 0x40); // Lock PPS
    
    IC1CONbits.ICM = 0b011;                   // Only rising edges
    IFS0bits.IC1IF = 0;
    IEC0bits.IC1IE = 1;
}

void __attribute__((__interrupt__, auto_psv)) _IC1Interrupt(void) {
    IFS0bits.IC1IF = 0;                      // Clear the IC1 interrupt flag
    run_test_pattern_flag = 1;
}

void set_servo(unsigned int percent) {
    // Range of input is 0-65535
    // 0 degree position --> 1000
    // 180 degree position --> 5000
    
    // Need to convert that to 0-100% for the servo
    OC1RS = (unsigned int)(((unsigned long)percent*4000)/65535 + 1000);
}

void set_servo2(unsigned int percent) {
    // Range of input is 0-65535
    // 0 degree position --> 1000
    // 180 degree position --> 5000
    
    // Need to convert that to 0-100% for the servo
    OC2RS = (unsigned int)(((unsigned long)(65535-percent)*4000)/65535 + 1000);
}

unsigned int distance(unsigned int x, unsigned int y) {
    // x and y from [0,1023]
    unsigned int n0 = MAX(x,y); // Take max (1 cycle)
    n0 *= 39;
    n0 = (n0 >> 5); // Divide by 32
    // Now we have our initial guess, 1.21875 times the max
    // Time to find number to take sqrt of
    unsigned long N = (unsigned long)x*x + (unsigned long)y*y;
    // Could split this part into its own sqrt function
    unsigned long dividend = (unsigned long)n0*((N*3+(unsigned long)n0*n0) >> 2);
    unsigned int divisor = MAX(((N + (unsigned long)3*n0*n0) >> 7),1);
    unsigned int result = ((dividend/divisor) >> 5);
    
    return result;
}

unsigned int calculate_inner_angle(unsigned int x, unsigned int y) {
    return inner_angle_table[distance(x,y)];
}

unsigned int calculate_arctan_index(unsigned int x, unsigned int y) {
    return (((long)y << 16) / MAX(x, 1) * (ARCTAN_TABLE_SIZE - 1)) >> 16;
}

unsigned int calculate_outer_angle(unsigned int x, unsigned int y) {
    // The goal is to always keep (y/x) or (x/y) under 1. We can use trig identities to flip these around.
    if (y < x) {
        return 0x8000 + arctan_table[calculate_arctan_index(x,y)] - (calculate_inner_angle(x,y) >> 1);
    }
    return 0x0000 - arctan_table[calculate_arctan_index(y,x)] - (calculate_inner_angle(x,y) >> 1);
}

void move_to(int new_x, int new_y, int cycles_to_travel) {
    // Draws a point to point line from the current position to the new position
    // Can't just divide because no floating point :(
    // So we scale up by the remaining amount: the max absolute value is 1023 = 2^10, so we have 15-10 = 5 bits left to work with.
    // This function also cannibalizes the main loop, so be careful using it. Only intended for test patterns.
    int distance_x = ((raw_x - new_x) << 5);
    int distance_y = ((raw_y - new_y) << 5);
    
    int temp_x = raw_x;
    int temp_y = raw_y;
    
    for (int i = 0 ; i < cycles_to_travel; i++) {
        raw_x -= ((distance_x/cycles_to_travel * i) >> 5);
        raw_y -= ((distance_y/cycles_to_travel * i) >> 5);
        
        update_servo_angles(1);
        
        raw_x = temp_x;
        raw_y = temp_y;
        
        delay_ms(DELAY_TIME); // Wait
        LATBbits.LATB15 ^= 1; // Toggle RB15 (heartbeat LED)
    }
    
    raw_x = new_x;
    raw_y = new_y;
}

void update_servo_angles(int print_to_lcd) {
    // Limit x to the range [64, 512]
    int x = MAX(X_OFFSET, raw_x);
    int y = raw_y;
    
    unsigned int inner_angle = calculate_inner_angle(x,y);
    unsigned int outer_angle = calculate_outer_angle(x,y);

    // Process values and store them in buffers
    put_val_inner(inner_angle);
    put_val_outer(outer_angle);

    // If the buffer contains valid data, set the servos
    if (inner_buffer[AVERAGE_COUNT] != 0) {
        set_servo(outer_average);
        set_servo2(inner_average);
    }
    
    // Display servo info if requested
    if (print_to_lcd) {
        lcd_clear();
        lcd_set_cursor(0,0); // Move to first line, divide by 364 for angle in degrees

        // Print outer angle
        lcd_print_int(outer_angle);

        lcd_set_cursor(2,0); // Move to second line
        lcd_print_int(inner_angle);

        // Print inner angle
        lcd_set_cursor(4,0); // Move to third line (need to fix setCursor)

        // Print coordinates
        lcd_print_int(x);
        lcd_print_char(',');
        lcd_print_char(' ');
        lcd_print_int(y);     
        
        lcd_set_cursor(6,0); // Move to third line (need to fix setCursor)

        // Print coordinates
        lcd_print_int(raw_x);
        lcd_print_char(',');
        lcd_print_char(' ');
        lcd_print_int(raw_y);     
    }
}

void run_test_pattern() {
    for (int i = 0; i < 5; i++) { 
        // Square
        move_to(693,693,CYCLES_TO_TRAVEL);
        move_to(331,693,CYCLES_TO_TRAVEL);
        move_to(331,331,CYCLES_TO_TRAVEL);
        move_to(693,331,CYCLES_TO_TRAVEL);


        //Circle (16-point)
//        move_to(693,693,CYCLES_TO_TRAVEL);
//        move_to(609, 748, CYCLES_TO_TRAVEL);
//        move_to(512, 768, CYCLES_TO_TRAVEL);
//        move_to(414, 748, CYCLES_TO_TRAVEL);
//        move_to(330, 693, CYCLES_TO_TRAVEL);
//        move_to(275, 609, CYCLES_TO_TRAVEL);
//        move_to(256, 512, CYCLES_TO_TRAVEL);
//        move_to(275, 414, CYCLES_TO_TRAVEL);
//        move_to(330, 330, CYCLES_TO_TRAVEL);
//        move_to(414, 275, CYCLES_TO_TRAVEL);
//        move_to(511, 256, CYCLES_TO_TRAVEL);
//        move_to(609, 275, CYCLES_TO_TRAVEL);
//        move_to(693, 330, CYCLES_TO_TRAVEL);
//        move_to(748, 414, CYCLES_TO_TRAVEL);
//        move_to(768, 512, CYCLES_TO_TRAVEL);
//        move_to(748, 609, CYCLES_TO_TRAVEL);
//        move_to(693, 693, CYCLES_TO_TRAVEL);
        
        // Horizontal Line
//        move_to(1023, 512, CYCLES_TO_TRAVEL);
//        move_to(128, 512, CYCLES_TO_TRAVEL);
    }
}

volatile int get_raw_x(void){
    return raw_x;
}

volatile int get_raw_y(void){
    return raw_y;
>>>>>>> 5b9b20fce1f3e7ab5a79c3e83cd2f8d4444519fb:troth004_plotter_library_v1.c
}